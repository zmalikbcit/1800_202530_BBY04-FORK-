import{o as F,f as O,i as P,e as T,u as b,s as v,j as K,d as I,q as S,c as q,w as G,l as H,g as J,n as Y}from"./firebaseConfig-D3CXmay8.js";/* empty css              */import"./bootstrap.esm-BEI9jhF-.js";import"./app-hhu_teIN.js";const s=e=>document.querySelector(e),A=(e,n)=>{const t=s(e);t&&(t.textContent=n)},z=e=>{try{if(e?.toDate)return e.toDate().toLocaleString();if(typeof e=="number")return new Date(e).toLocaleString()}catch{}return""},_=e=>(e||"").toLowerCase().trim().replace(/[^a-z0-9-]+/g,"-"),W=e=>(e||"").toLowerCase().trim().replace(/[^a-z0-9-]+/g,"-").replace(/^-+|-+$/g,"").replace(/--+/g,"-").slice(0,40),r={groupId:null,groupDoc:null,currentUser:null,isAdmin:!1,memberProfileMap:new Map,memberProfileUnsubs:new Map},m=()=>T(I,"groups",r.groupId);async function Q(){const e=await K(m());if(!e.exists())throw new Error("Group not found");return r.groupDoc={id:e.id,ref:m(),...e.data()},B(),r.groupDoc}function B(){const e=r.groupDoc?.ownerUid,n=Array.isArray(r.groupDoc?.admins)?r.groupDoc.admins:[],t=r.currentUser?.uid;return r.isAdmin=!!(t&&(t===e||n.includes(t))),r.isAdmin}const V={eggs:{name:"Eggs",amount:12,unit:"pcs",baseline:6},milk:{name:"Milk",amount:1,unit:"L",baseline:1},bread:{name:"Bread",amount:1,unit:"loaf",baseline:1},butter:{name:"Butter",amount:1,unit:"pack",baseline:1},rice:{name:"Rice",amount:2,unit:"kg",baseline:1}};async function X(){const e=r.groupDoc?.pantry||{};Object.keys(e).length||await b(m(),{pantry:V,pantryUpdatedAt:v()})}const h=()=>r.groupDoc?.pantry||{},w=(e,n)=>b(m(),{[`pantry.${e}`]:n,pantryUpdatedAt:v()}),Z=e=>b(m(),{[`pantry.${e}`]:Y(),pantryUpdatedAt:v()});function L(){const e=Array.isArray(r.groupDoc?.users)?r.groupDoc.users:[],n=new Set(e.map(t=>t?.uid).filter(Boolean));for(const[t,o]of r.memberProfileUnsubs.entries())if(!n.has(t)){try{o()}catch{}r.memberProfileUnsubs.delete(t),r.memberProfileMap.delete(t)}for(const t of n){if(r.memberProfileUnsubs.has(t))continue;const o=T(I,"users",t),i=P(o,a=>{a.exists()?r.memberProfileMap.set(t,a.data()):r.memberProfileMap.delete(t),E()},a=>{console.warn("Profile listener error for uid:",t,a)});r.memberProfileUnsubs.set(t,i)}}function U(){const e=r.groupDoc||{};A("#groupName",e.name||"Untitled Group"),A("#groupDescription",e.description||"No group description yet.");const n=[`Privacy: ${e.privacy||"private"}`,`Owner: ${(e.users||[]).find(c=>c.uid===e.ownerUid)?.displayName||e.ownerUid||"unknown"}`,e.createdAt?`Created: ${z(e.createdAt)}`:null,`Join name: ${e.joinKey||r.groupId}`].filter(Boolean).join(" • ");A("#groupMeta",n);const t=s("#groupImage");if(t){const c=e.code||"default-group";t.src=`./images/${c}.jpg`,t.alt=`${e.name||"Group"} image`}const o=s("#adminPanel");o&&o.classList[r.isAdmin?"remove":"add"]("d-none");const i=s("#renameInput");i&&(i.value=e.name||"");const a=s("#joinKeyInput");a&&(a.value=e.joinKey||r.groupId)}function E(){const e=s("#memberChips"),n=s("#memberChipTemplate");!e||!n||(e.innerHTML="",(Array.isArray(r.groupDoc?.users)?r.groupDoc.users:[]).sort((t,o)=>{const i=t?.joinedAt?.toMillis?.()??+new Date(t?.joinedAt||0),a=o?.joinedAt?.toMillis?.()??+new Date(o?.joinedAt||0);return i-a}).forEach(t=>{const o=n.content.cloneNode(!0),i=r.memberProfileMap.get(t.uid)||{},a=i.displayName||t.displayName,c=i.username||t.username,l=i.email||t.email,d=i.photoURL||t.photoURL,p=a||c||(l?l.split("@")[0]:null)||"Member";o.querySelector(".avatar").src=d||"/images/default_user.png",o.querySelector(".avatar").alt=`${p} avatar`,o.querySelector(".name").textContent=p;const u=t.uid===r.groupDoc?.ownerUid,y=o.querySelector(".role");y&&(y.textContent=u?" • owner":"");const f=o.querySelector(".remove");r.isAdmin&&!u?f.addEventListener("click",()=>de(t.uid,p)):f.remove(),e.appendChild(o)}),e.children.length||(e.innerHTML='<div class="meta">No members to show.</div>'))}function C(){const e=s("#deleteBtn"),n=s("#leaveBtn"),t=r.currentUser?.uid,o=Array.isArray(r.groupDoc?.users)?r.groupDoc.users:[],i=r.isAdmin,a=!!t&&o.some(c=>c.uid===t);if(e&&e.classList[i?"remove":"add"]("d-none"),n){const c=!i&&a;n.classList[c?"remove":"add"]("d-none")}}async function ee(){if(!r.currentUser||!r.groupDoc){alert("You must be signed in and have a group loaded to leave.");return}if(!confirm("Leave this group?"))return;const e=r.currentUser.uid;try{const n=Array.isArray(r.groupDoc.users)?r.groupDoc.users:[],t=n.filter(o=>o&&o.uid!==e);if(t.length===n.length){alert("You are not currently listed as a member of this group.");return}await b(m(),{users:t,userUids:t.map(o=>o.uid),pantryUpdatedAt:v(),updatedAt:v()}),r.groupDoc.users=t,L(),C()}catch(n){console.error("Failed to leave group:",n),alert("Failed to leave the group. Check console for details.")}}async function te(){if(!r.isAdmin||!r.groupDoc){alert("Only a group admin/owner can delete this group.");return}if(confirm("Delete this group? This cannot be undone!"))try{await b(m(),{deletedAt:v()})}catch(e){console.error("Failed to delete group:",e),alert("Failed to delete the group.")}}function ne(e){return Object.entries(e).reduce((n,[t,o])=>{const i=+o?.amount||0,a=+o?.baseline||0;return a>0&&i<a&&n.push({key:t,name:o.name||t,need:Math.ceil(a-i),unit:o.unit||""}),n},[]).sort((n,t)=>n.name.localeCompare(t.name))}function g(){const e=s("#pantryTbody");if(!e)return;e.innerHTML="";const n=h(),t=Object.keys(n).sort((o,i)=>(n[o].name||o).localeCompare(n[i].name||i));if(!t.length){e.innerHTML='<tr><td colspan="5" class="meta">No items yet. Add something above.</td></tr>',j();return}t.forEach(o=>{const i=n[o],a=document.createElement("tr"),c=document.createElement("td");c.textContent=i.name||o;const l=document.createElement("td");l.className="text-end";const d=document.createElement("input");Object.assign(d,{type:"number",min:"0",step:"1",value:Number(i.amount||0)}),d.className="form-control",d.addEventListener("change",()=>oe(o,Number(d.value))),l.appendChild(d);const p=document.createElement("td"),u=document.createElement("input");Object.assign(u,{type:"text",placeholder:"Unit",value:i.unit||""}),u.className="form-control",u.addEventListener("change",()=>ae(o,u.value)),p.appendChild(u);const y=document.createElement("td");y.className="text-end";const f=document.createElement("input");Object.assign(f,{type:"number",min:"0",step:"1",value:Number(i.baseline||0)}),f.className="form-control",f.disabled=!r.isAdmin,f.addEventListener("change",()=>r.isAdmin&&ie(o,Number(f.value))),y.appendChild(f);const M=document.createElement("td"),N=(k,R,$)=>{const D=document.createElement("button");return D.className=R,D.textContent=k,D.addEventListener("click",$),D};M.append(N("–","btn btn-outline-secondary me-1",()=>x(o,-1)),N("+","btn btn-outline-secondary me-1",()=>x(o,1))),r.isAdmin&&M.append(N("Remove","btn btn-outline-danger",()=>se(o))),a.append(c,l,p,y,M),e.appendChild(a)}),j()}function j(){const e=s("#groceryList");if(!e)return;e.innerHTML="";const n=ne(h());if(!n.length){const t=document.createElement("li");t.className="grocery-item",t.innerHTML="<span></span><div>You're all stocked!</div><span></span>",e.appendChild(t);return}n.forEach(({key:t,name:o,need:i,unit:a})=>{const c=document.createElement("li");c.className="grocery-item";const l=document.createElement("input");l.type="checkbox";const d=document.createElement("div");d.innerHTML=`${o} <span class="qty">${i}${a?" "+a:""}</span>`;const p=document.createElement("button");p.className="btn btn-outline-secondary",p.textContent="Dismiss",p.addEventListener("click",()=>{const u=h()[t];if(!u)return;const y=Math.max(+u.amount||0,+u.baseline||0);w(t,{...u,amount:y}).then(g)}),c.append(l,d,p),e.appendChild(c)})}async function re(e){e.preventDefault();const n=s("#addItemName").value.trim(),t=Number(s("#addItemAmount").value),o=(s("#addItemUnit").value||"").trim();if(!n||!Number.isFinite(t)||t<0)return;const i=_(n),a=h()[i],c=a?{...a,name:n,unit:o,amount:Math.max(0,Math.floor((a.amount||0)+t))}:{name:n,unit:o,amount:Math.floor(t),baseline:0};await w(i,c),s("#addItemName").value="",s("#addItemAmount").value="",s("#addItemUnit").value="",g()}async function oe(e,n){const t=h()[e];if(!t)return alert("This item was removed by an admin.");await w(e,{...t,amount:Math.max(0,Number.isFinite(n)?Math.floor(n):0)}),g()}async function x(e,n){const t=h()[e];if(!t)return alert("This item was removed by an admin.");await w(e,{...t,amount:Math.max(0,Math.floor((t.amount||0)+n))}),g()}async function ae(e,n){const t=h()[e];if(!t)return alert("This item was removed by an admin.");await w(e,{...t,unit:n||""}),g()}async function ie(e,n){if(!r.isAdmin)return alert("Only the owner can change baselines.");const t=h()[e];t&&(await w(e,{...t,baseline:Math.max(0,Number.isFinite(n)?Math.floor(n):0)}),g())}async function se(e){if(!r.isAdmin)return alert("Only the group owner can remove items.");confirm("Remove this item from the pantry?")&&(await Z(e),g())}async function ce(){if(!r.isAdmin)return alert("Only the owner can rename this group.");const e=(s("#renameInput")?.value||"").trim();if(!e)return alert("Please enter a group name.");try{await b(m(),{name:e}),r.groupDoc.name=e,U(),alert("Group name updated.")}catch(n){console.error(n),alert("Failed to rename group.")}}async function ue(){if(!r.isAdmin)return alert("Only the owner can change the join name.");const e=(s("#joinKeyInput")?.value||"").trim(),n=W(e);if(!n)return alert("Join name is required.");if(n===(r.groupDoc.joinKey||r.groupId))return alert("Join name is unchanged.");try{const t=S(q(I,"groups"),G("joinKey","==",n),H(1)),o=await J(t);if(!o.empty&&o.docs[0].id!==r.groupId)return alert("That join name is already taken.");await b(m(),{joinKey:n}),r.groupDoc.joinKey=n,U(),alert("Join name updated.")}catch(t){console.error(t),alert("Failed to update join name.")}}async function de(e,n){if(!r.isAdmin)return alert("Only the owner can remove members.");if(!(!e||!confirm(`Remove ${n} from the group?`)))try{const t=(Array.isArray(r.groupDoc.users)?r.groupDoc.users:[]).filter(o=>o.uid!==e);await b(m(),{users:t,userUids:t.map(o=>o.uid),updatedAt:v()}),r.groupDoc.users=t,L(),E(),alert("Member removed.")}catch(t){console.error(t),alert("Failed to remove member.")}}function me(){s("#openChatBtn")?.addEventListener("click",()=>{window.location.href=`/groupChat.html?docID=${encodeURIComponent(r.groupId)}`}),s("#leaveBtn")?.addEventListener("click",ee),s("#deleteBtn")?.addEventListener("click",te),s("#saveRenameBtn")?.addEventListener("click",ce),s("#saveJoinKeyBtn")?.addEventListener("click",ue),s("#addPantryForm")?.addEventListener("submit",re),s("#clearCheckedBtn")?.addEventListener("click",()=>document.querySelectorAll("#groceryList input[type=checkbox]").forEach(e=>e.checked=!1))}async function le(e){if(r.currentUser=e||null,r.groupId=new URL(location.href).searchParams.get("docID"),!r.groupId)return A("#groupName","Group not found");try{await Q(),L(),U(),E(),await X(),g(),C(),P(m(),async n=>{const t=n.metadata.hasPendingWrites,o=n.data()||null;if(!n.exists()||!!o?.deletedAt){t||(alert("This group has been deleted."),window.location.href="/main.html");return}r.groupDoc={id:n.id,ref:m(),...o},B();const a=r.currentUser?.uid,c=Array.isArray(r.groupDoc.users)?r.groupDoc.users:[],l=!!a&&c.some(d=>d.uid===a);if(!t&&a&&!l&&a!==r.groupDoc.ownerUid){alert("You are no longer a member of this group."),window.location.href="/main.html";return}L(),U(),E(),g(),C()})}catch(n){console.error(n),A("#groupName","Error loading group.")}}document.addEventListener("DOMContentLoaded",()=>{me(),F(O(),e=>{le(e)})});
