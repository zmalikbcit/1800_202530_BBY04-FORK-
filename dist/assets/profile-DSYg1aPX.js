import{o as S,f as g,h as B,i as N,e as E,u as y,s,j as U,k as q,q as v,w as D,c as L,d as f,g as G,m as R}from"./firebaseConfig-D3CXmay8.js";/* empty css              */import"./bootstrap.esm-BEI9jhF-.js";import"./app-hhu_teIN.js";const n=e=>document.querySelector(e),d=(e,a)=>{const o=n(e);o&&(o.textContent=a)},w=e=>{try{if(e?.toDate)return e.toDate().toLocaleString();if(typeof e=="number")return new Date(e).toLocaleString()}catch{}return""},t={currentUser:null,profileUid:null,profileDoc:null,isMe:!1,unsubGroups:null},l=()=>E(f,"users",t.profileUid);async function C(){const e=l(),a=await U(e);if(!a.exists()){if(!t.isMe||!t.currentUser)throw new Error("User profile not found");const o=t.currentUser,r=o.displayName||(o.email?o.email.split("@")[0]:"user"),i={username:r,displayName:o.displayName||r,photoURL:o.photoURL||null,email:o.email||null,bio:"",createdAt:s(),updatedAt:s()};await q(e,i,{merge:!0});const c=await U(e);return t.profileDoc={id:c.id,ref:e,...c.data()},t.profileDoc}return t.profileDoc={id:a.id,ref:e,...a.data()},t.profileDoc}function m(){const e=t.profileDoc||{},a=e.username||e.displayName||e.name||(e.email?e.email.split("@")[0]:"Unnamed user");d("#profileName",e.displayName||a),d("#profileBio",e.bio||"No bio yet.");const o=[e.email?`Email: ${e.email}`:null,e.createdAt?`Joined: ${w(e.createdAt)}`:null,e.lastLoginAt?`Last login: ${w(e.lastLoginAt)}`:null].filter(Boolean).join(" â€¢ ");d("#profileMeta",o);const r=n("#profileImage");r&&(r.src=e.photoURL||"/images/default_user.png",r.alt=`${e.displayName||a} avatar`);const i=n("#editPanel");i&&i.classList[t.isMe?"remove":"add"]("d-none"),t.isMe&&(n("#displayNameInput").value=e.displayName||"",n("#bioInput").value=e.bio||"",n("#photoUrlInput").value=e.photoURL||"")}function I(e){const a=n("#groupChips"),o=n("#groupChipTemplate");if(!(!a||!o)){if(a.innerHTML="",!e.length){a.innerHTML='<div class="meta">No groups yet.</div>';return}e.sort((r,i)=>(r.name||"").localeCompare(i.name||"")).forEach(r=>{const i=o.content.cloneNode(!0);i.querySelector(".name").textContent=r.name||"Untitled Group",i.querySelector(".avatar").src=r.code?`./images/${r.code}.jpg`:"/images/group-placeholder.png",i.querySelector(".avatar").alt=`${r.name||"Group"} image`,i.querySelector(".member-chip").style.cursor="pointer",i.querySelector(".member-chip").addEventListener("click",()=>{window.location.href=`/myGroup.html?docID=${encodeURIComponent(r.id)}`}),a.appendChild(i)})}}function k(e){const a=v(L(f,"groups"),D("userUids","array-contains",e));t.unsubGroups?.(),t.unsubGroups=N(a,o=>{const r=o.docs.map(i=>({id:i.id,...i.data()}));I(r)})}async function b(e,a){const o=v(L(f,"groups"),D("userUids","array-contains",e)),r=await G(o);if(r.empty)return;const i=R(f);r.forEach(c=>{const h=c.data(),A=(Array.isArray(h.users)?h.users:[]).map(u=>{if(u?.uid!==e)return u;const p={...u,...a},M=p.username||p.displayName||u.username||u.displayName;return p.displayName=p.displayName||M||"Member",p});i.update(c.ref,{users:A,updatedAt:s()})}),await i.commit()}async function x(){if(!t.isMe)return;const e=(n("#displayNameInput")?.value||"").trim();if(!e)return alert("Display name cannot be empty.");try{await y(l(),{displayName:e,username:t.profileDoc.username||e,updatedAt:s()}),await b(t.profileUid,{displayName:e}),t.profileDoc.displayName=e,m(),alert("Display name updated.")}catch(a){console.error(a),alert("Failed to update display name.")}}async function $(){if(!t.isMe)return;const e=(n("#bioInput")?.value||"").trim();try{await y(l(),{bio:e,updatedAt:s()}),t.profileDoc.bio=e,m(),alert("Bio updated.")}catch(a){console.error(a),alert("Failed to update bio.")}}async function P(){if(!t.isMe)return;const e=(n("#photoUrlInput")?.value||"").trim();try{await y(l(),{photoURL:e,updatedAt:s()}),await b(t.profileUid,{photoURL:e}),t.profileDoc.photoURL=e,m(),alert("Photo updated.")}catch(a){console.error(a),alert("Failed to update photo.")}}function T(){n("#saveDisplayNameBtn")?.addEventListener("click",x),n("#saveBioBtn")?.addEventListener("click",$),n("#savePhotoBtn")?.addEventListener("click",P),n("#goGroupsBtn")?.addEventListener("click",()=>{window.location.href="/main.html"}),n("#signOutBtn")?.addEventListener("click",async()=>{await B(g()),window.location.href="/index.html"})}async function j(e){t.currentUser=e||null;const a=new URL(location.href).searchParams;if(t.profileUid=a.get("uid")||e?.uid,!t.profileUid){d("#profileName","No user selected.");return}t.isMe=!!e&&t.profileUid===e.uid;try{await C(),m(),k(t.profileUid),N(l(),o=>{o.exists()&&(t.profileDoc={id:o.id,ref:l(),...o.data()},m())})}catch(o){console.error(o),d("#profileName","Error loading profile.")}}document.addEventListener("DOMContentLoaded",()=>{T(),S(g(),e=>j(e))});
